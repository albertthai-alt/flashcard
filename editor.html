<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23FFA500'><path d='M20.71 5.63l-2.34-2.34a1 1 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.83-1.83a1 1 0 0 0 0-1.42zM3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z'/></svg>" type="image/svg+xml">
    <style>
        /* Read button styles */
        .read-btn {
            background: none;
            border: none;
            color: #5f6368;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .read-btn:hover {
            background-color: #f1f3f4;
            color: #202124;
        }
        .read-btn:active {
            background-color: #e8eaed;
        }
        .read-btn svg {
            pointer-events: none;
        }
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 30px;
        }
        .container {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
        }
        .text-box {
            flex: 1;
            min-width: 0; /* Prevents flex items from overflowing */
        }
        textarea {
            width: 100%;
            height: 180px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: vertical;
            font-size: 14px;
            line-height: 1.5;
        }
        .translation-group {
            margin-bottom: 30px;
            border: 1px solid #eee;
            padding: 20px;
            border-radius: 8px;
            background: #fff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .translation-group h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .button-container {
            text-align: center;
            margin: 20px 0;
        }
        /* Default button styles - all white with gray border */
        button {
            padding: 8px 16px;
            background-color: white;
            color: #202124;
            border: 1px solid #dadce0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            margin: 2px;
            box-shadow: none;
        }
        button:hover {
            background-color: #f8f9fa;
            border-color: #dadce0;
        }
        
        /* Card toggle buttons */
        .switch-btn, #switchToEnVi, #switchToViEn {
            padding: 5px 15px;
            background: #f8f9fa;
            color: #202124;
            border: 1px solid #dadce0;
            border-radius: 20px;
            margin: 0 2px;
        }
        .switch-btn.active, #switchToEnVi.active, #switchToViEn.active {
            background: #f1f3f4;
            color: #202124;
            font-weight: 500;
        }
        .card-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 3px;
            z-index: 1; /* Ensure buttons are above other content */
        }
        .card-actions button {
            padding: 2px 6px;
            font-size: 11px;
            background: none;
            border: none;
            color: #5f6368;
            text-decoration: none;
            opacity: 0.7;
        }
        .card-actions button:hover {
            background: none;
            color: #202124;
            box-shadow: none;
            opacity: 1;
            text-decoration: underline;
        }
        .edit-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }
        .edit-buttons button {
            padding: 4px 12px;
            font-size: 13px;
        }
        .edit-buttons .save-btn {
            background-color: white;
            color: #202124;
            border: 1px solid #dadce0;
        }
        .edit-buttons .save-btn:hover {
            background-color: #f8f9fa;
            border-color: #d2e3fc;
        }
        .edit-buttons .cancel-btn {
            background-color: #f1f3f4;
            color: #5f6368;
            border: 1px solid #dadce0;
        }
        .edit-buttons .cancel-btn:hover {
            background-color: #e8eaed;
            color: #202124;
        }
        .card-item {
            position: relative;
            background: white;
            border: 1px solid #dadce0;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 12px;
            transition: box-shadow 0.2s;
        }
        .card-item:hover {
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.1), 0 1px 3px 1px rgba(0,0,0,0.1);
        }
        .card-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            word-wrap: break-word;
            white-space: pre-line;
            overflow-wrap: break-word;
            padding: 0 5px;
        }
        .card-term, .card-definition {
            padding: 12px;
            background: #f9f9f9;
            border-radius: 6px;
            word-break: break-word;
            min-height: 40px;
            border: 1px solid #f0f0f0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div style="margin-bottom: 20px;">
        <h1>Editor</h1>
    </div>
    
    <!-- English to Vietnamese -->
    <div class="translation-group">
        <h3>Dịch Anh - Việt</h3>
        <div class="container">
            <div class="text-box">
                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                    <label for="englishText" style="margin: 0; margin-right: 10px;">Tiếng Anh:</label>
                    <button class="read-btn" data-target="englishText" data-lang="en-US" title="Đọc văn bản">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                        </svg>
                    </button>
                </div>
                <textarea id="englishText" placeholder="Nhập văn bản tiếng Anh..."></textarea>
                <div style="margin-top: 10px;">
                    <button id="translateEnToViBtn">Dịch sang tiếng Việt</button>
                    <button id="addEnViCardBtn" style="margin-left: 10px;">Thêm thẻ</button>
                </div>
            </div>
            
            <div class="text-box">
                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                    <label for="vietnameseText" style="margin: 0; margin-right: 10px;">Tiếng Việt:</label>
                    <button class="read-btn" data-target="vietnameseText" data-lang="vi-VN" title="Đọc văn bản">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                        </svg>
                    </button>
                </div>
                <textarea id="vietnameseText" placeholder="Bản dịch tiếng Việt sẽ xuất hiện ở đây..."></textarea>
            </div>
        </div>
    </div>
    
    <!-- Vietnamese to English -->
    <div class="translation-group">
        <h3>Dịch Việt - Anh</h3>
        <div class="container">
            <div class="text-box">
                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                    <label for="vietnameseText2" style="margin: 0; margin-right: 10px;">Tiếng Việt:</label>
                    <button class="read-btn" data-target="vietnameseText2" data-lang="vi-VN" title="Đọc văn bản">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                        </svg>
                    </button>
                </div>
                <textarea id="vietnameseText2" placeholder="Nhập văn bản tiếng Việt..."></textarea>
                <div style="margin-top: 10px;">
                    <button id="translateViToEnBtn">Dịch sang tiếng Anh</button>
                    <button id="addViEnCardBtn" style="margin-left: 10px;">Thêm thẻ</button>
                </div>
            </div>
            
            <div class="text-box">
                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                    <label for="englishText2" style="margin: 0; margin-right: 10px;">Tiếng Anh:</label>
                    <button class="read-btn" data-target="englishText2" data-lang="en-US" title="Read text">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                        </svg>
                    </button>
                </div>
                <textarea id="englishText2" placeholder="English translation will appear here..."></textarea>
            </div>
        </div>
    </div>
    
    <div class="button-container" style="display: flex; align-items: center; gap: 15px;">
    </div>
    
    <div id="cardPreview" style="margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div style="display: flex; align-items: center;">
                <h3 style="margin: 0 15px 0 0;">Xem trước thẻ:</h3>
                <div class="switch-container" style="display: flex; border: 1px solid #ccc; border-radius: 20px; overflow: hidden;">
                    <button id="switchToEnVi" class="switch-btn active" style="border: none; padding: 5px 15px; background: #4285f4; color: white; cursor: pointer;">Anh - Việt</button>
                    <button id="switchToViEn" class="switch-btn" style="border: none; padding: 5px 15px; background: #f5f5f5; color: #333; cursor: pointer;">Việt - Anh</button>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="saveCardBtn" style="background-color: #34a853; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer;">Lưu thẻ</button>
                <button id="deleteCardsBtn" style="background-color: #ea4335; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer;">Xóa thẻ</button>
            </div>
        </div>
        <div id="enViCardList" class="card-list" style="background: #f5f5f5; padding: 15px; border-radius: 4px; display: block;">
            <!-- English-Vietnamese cards will be added here -->
        </div>
        <div id="viEnCardList" class="card-list" style="background: #f5f5f5; padding: 15px; border-radius: 4px; display: none;">
            <!-- Vietnamese-English cards will be added here -->
        </div>
    </div>

    <script>
        // Function to save cards to JSON file
        function saveCardsToFile(cards, filename = 'flashcards.json') {
            const data = JSON.stringify(cards, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Function to get all cards from a container with deduplication
        const getAllCards = (containerId) => {
            const cards = [];
            const seen = new Set();
            
            document.querySelectorAll(`#${containerId} > .card-item`).forEach(card => {
                const content = card.querySelector('.card-content');
                if (content) {
                    const term = (content.querySelector('.card-term')?.textContent || '').trim();
                    const definition = (content.querySelector('.card-definition')?.textContent || '').trim();
                    
                    // Create a unique key for this card
                    const cardKey = `${term}|||${definition}`;
                    
                    if ((term || definition) && !seen.has(cardKey)) {
                        seen.add(cardKey);
                        cards.push({ term, definition });
                    }
                }
            });
            return cards;
        };

        // API configuration
        const API_MASTER_KEY = '$2a$10$xn4fMyT.KvPOUmj84gm9t.YtAcoyYCV6Vti1YZtWz9Ivo3EUq0eCy';
        const BIN_ID = '690d8f53d0ea881f40d91199';
        const API_BASE_URL = 'https://api.jsonbin.io/v3/b';
        
        // Function to save all data to jsonbin.io
        async function saveAllData() {
            try {
                // First get all current data
                const enViCards = getAllCards('enViCardList');
                const viEnCards = getAllCards('viEnCardList');
                
                // Prepare data to save
                const dataToSave = {
                    englishText: document.getElementById('englishText').value,
                    vietnameseText: document.getElementById('vietnameseText').value,
                    englishText2: document.getElementById('englishText2').value,
                    vietnameseText2: document.getElementById('vietnameseText2').value,
                    enViCards: enViCards,
                    viEnCards: viEnCards,
                    lastSaved: new Date().toISOString()
                };
                
                // Save all data to the single bin
                try {
                    const response = await fetch(`${API_BASE_URL}/${BIN_ID}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': API_MASTER_KEY,
                            'X-Bin-Name': 'Flashcards',
                            'X-Bin-Versioning': 'false'
                        },
                        body: JSON.stringify({
                            enViCards,
                            viEnCards,
                            lastUpdated: new Date().toISOString()
                        })
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(`Failed to save data (${response.status}): ${JSON.stringify(result)}`);
                    }
                } catch (error) {
                    throw new Error(`Failed to save data: ${error.message}`);
                };

                // Update last saved time
                const now = new Date();
                localStorage.setItem('lastSaved', now.toISOString());
                updateLastSavedDisplay();

                return true;
            } catch (error) {
                alert('Lỗi khi lưu dữ liệu: ' + error.message);
                return false;
            }
        }
        
        // Format timestamp to display
        const formatTimestamp = (timestamp) => {
            if (!timestamp) return 'Chưa lưu';
            try {
                const date = new Date(timestamp);
                return date.toLocaleTimeString('vi-VN', { 
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (e) {
                console.error('Error formatting timestamp:', e);
                return 'Chưa lưu';
            }
        };

        // Function to update last saved time display
        const updateLastSavedDisplay = () => {
            try {
                const lastSavedEl = document.getElementById('lastSaved');
                if (!lastSavedEl) return;
                
                // The last saved time is now managed in the data object from jsonbin.io
                // This function is kept for backward compatibility
                if (lastSavedEl.textContent === 'Đang tải...' || lastSavedEl.textContent === 'Chưa lưu') {
                    // Don't override the loading or not saved state
                    return;
                }
                
                // If we have a last saved time in the data, it will be shown by loadPageContent
                // Otherwise, show 'Chưa lưu'
                if (lastSavedEl.textContent === '') {
                    lastSavedEl.textContent = 'Chưa lưu';
                }
                
            } catch (error) {
                console.error('Error updating last saved display:', error);
                const lastSavedEl = document.getElementById('lastSaved');
                if (lastSavedEl) {
                    lastSavedEl.textContent = 'Lỗi tải thời gian';
                    lastSavedEl.style.color = '#ea4335';
                }
            }
        };

        // Function to initialize the page
        const initializePage = async () => {
            try {
                // Clear any existing data
                const lastSavedEl = document.getElementById('lastSaved');
                if (lastSavedEl) lastSavedEl.textContent = 'Đang tải...';

                // Show loading state for card lists
                const enViCardList = document.getElementById('enViCardList');
                const viEnCardList = document.getElementById('viEnCardList');
                if (enViCardList) enViCardList.innerHTML = '<div>Đang tải thẻ...</div>';
                if (viEnCardList) viEnCardList.innerHTML = '<div>Đang tải thẻ...</div>';

                // Try to load data from the single bin
                const response = await fetch(`${API_BASE_URL}/${BIN_ID}/latest`, {
                    headers: {
                        'X-Master-Key': API_MASTER_KEY
                    }
                }).catch(error => {
                    console.error('Error loading data:', error);
                    return { ok: false, status: 'error', error };
                });

                let data = {
                    enViCards: [],
                    viEnCards: []
                };

                // Process the response
                if (response && response.ok) {
                    try {
                        const result = await response.json();
                        if (result.record) {
                            data = {
                                enViCards: Array.isArray(result.record.enViCards) ? result.record.enViCards : [],
                                viEnCards: Array.isArray(result.record.viEnCards) ? result.record.viEnCards : []
                            };
                        }
                    } catch (e) {
                        console.error('Error parsing data:', e);
                    }
                }

                // Ensure we have arrays for cards
                if (!Array.isArray(data.enViCards)) data.enViCards = [];
                if (!Array.isArray(data.viEnCards)) data.viEnCards = [];

                // Update text areas only if they're empty
                const textElements = {
                    'englishText': data.englishText,
                    'vietnameseText': data.vietnameseText,
                    'englishText2': data.englishText2,
                    'vietnameseText2': data.vietnameseText2
                };
                
                Object.entries(textElements).forEach(([id, value]) => {
                    if (value) {  // Only update if we have a value from the server
                        const element = document.getElementById(id);
                        if (element && !element.value) {  // Only update if the field is empty
                            element.value = value;
                        }
                    }
                });

                // Update last saved time
                const lastSavedElement = document.getElementById('lastSaved');
                if (lastSavedElement) {
                    lastSavedElement.textContent = data.lastSaved ? formatTimestamp(data.lastSaved) : 'Chưa lưu';
                }

                // Clear and load card lists
                if (enViCardList) enViCardList.innerHTML = '';
                if (viEnCardList) viEnCardList.innerHTML = '';

                // Load cards if we have data
                if (data.enViCards && data.enViCards.length > 0) {
                    loadCards('enViCardList', data.enViCards);
                }
                if (data.viEnCards && data.viEnCards.length > 0) {
                    loadCards('viEnCardList', data.viEnCards);
                }

                // Show card preview if we have any cards
                const cardPreview = document.getElementById('cardPreview');
                const hasCards = (data.enViCards && data.enViCards.length > 0) || (data.viEnCards && data.viEnCards.length > 0);

                if (cardPreview) {
                    cardPreview.style.display = hasCards ? 'block' : 'none';
                }

            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
                const lastSavedEl = document.getElementById('lastSaved');
                if (lastSavedEl) lastSavedEl.textContent = 'Lỗi tải dữ liệu';
                alert('Không thể tải dữ liệu từ máy chủ. Vui lòng kiểm tra kết nối mạng và thử lại.');
            }
        }

        // Function to load card sets with deduplication
        const loadCards = (cardListId, cardsData) => {
            const cardList = document.getElementById(cardListId);
            if (!cardList) return;

            if (!Array.isArray(cardsData) || cardsData.length === 0) {
                cardList.innerHTML = '<div class="no-cards">Chưa có thẻ nào</div>';
                return;
            }

            // Clear existing cards
            cardList.innerHTML = '';

            // Use a Set to track unique cards
            const uniqueCards = [];
            const seen = new Set();

            // Filter out duplicates and handle different card formats
            cardsData.forEach(card => {
                if (!card) return;

                // Handle different card formats
                let term, definition;

                if (typeof card === 'object') {
                    // Handle {term: '...', definition: '...'} format
                    term = (card.term || card.front || '').toString().trim();
                    definition = (card.definition || card.back || '').toString().trim();
                } else if (Array.isArray(card) && card.length >= 2) {
                    // Handle array format [term, definition]
                    term = (card[0] || '').toString().trim();
                    definition = (card[1] || '').toString().trim();
                } else {
                    // Skip if we can't parse the card
                    return;
                }

                // Skip if both term and definition are empty
                if (!term && !definition) return;

                const cardKey = `${term}|||${definition}`.toLowerCase();

                if (!seen.has(cardKey)) {
                    seen.add(cardKey);
                    uniqueCards.push({ term, definition });
                }
            });

            if (uniqueCards.length === 0) {
                cardList.innerHTML = '<div class="no-cards">Chưa có thẻ nào</div>';
                return;
            }

            // Add unique cards to the list
            const isEnToVi = cardListId === 'enViCardList';

            uniqueCards.forEach((card, index) => {
                try {
                    const cardContainer = document.createElement('div');
                    cardContainer.className = 'card-item';

                    const cardContent = createCardContent(
                        card.term, 
                        card.definition, 
                        isEnToVi
                    );

                    if (cardContent) {
                        cardContainer.appendChild(cardContent);
                        cardList.appendChild(cardContainer);
                    }
                } catch (e) {
                    console.error('Error creating card:', e, card);
                }
            });

        };

        // Function to safely parse JSON from localStorage
        const safeJsonParse = (jsonString, defaultValue = []) => {
            try {
                return jsonString ? JSON.parse(jsonString) : defaultValue;
            } catch (e) {
                console.error('Error parsing JSON:', e);
                return defaultValue;
            }
        };

        // Text-to-speech function
        function speakText(text, lang) {
            if (!text) return;

            // Stop any currently playing speech
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang || 'en-US';

            // Set voice based on language
            const voices = window.speechSynthesis.getVoices();
            const preferredVoices = {
                'vi-VN': voices.find(v => v.lang === 'vi-VN'),
                'en-US': voices.find(v => v.lang === 'en-US' || v.lang === 'en-GB')
            };

            if (preferredVoices[utterance.lang]) {
                utterance.voice = preferredVoices[utterance.lang];
            }
            
            window.speechSynthesis.speak(utterance);
        }
        
        // Function to load data from jsonbin.io
        async function loadFromJsonBin() {
            try {
                // Show loading state
                const lastSavedEl = document.getElementById('lastSaved');
                if (lastSavedEl) lastSavedEl.textContent = 'Đang tải...';

                // Try to load data from the single bin
                const response = await fetch(`${API_BASE_URL}/${BIN_ID}/latest`, {
                    headers: {
                        'X-Master-Key': API_MASTER_KEY
                    }
                }).catch(error => {
                    return { ok: false, status: 'error', error };
                });

                let enViCards = [];
                let viEnCards = [];

                if (response && response.ok) {
                    try {
                        const result = await response.json();
                        
                        // Handle the response
                        if (result.record) {
                            // Check if we have enViCards and viEnCards in the record
                            if (result.record.enViCards) {
                                enViCards = Array.isArray(result.record.enViCards) ? result.record.enViCards : [];
                                if (enViCards.length > 0) {
                                    loadCards('enViCardList', enViCards);
                                }
                            }
                            
                            if (result.record.viEnCards) {
                                viEnCards = Array.isArray(result.record.viEnCards) ? result.record.viEnCards : [];
                                if (viEnCards.length > 0) {
                                    loadCards('viEnCardList', viEnCards);
                                }
                            }
                            
                            // Update last saved time if available
                            if (result.record.lastUpdated) {
                                const lastSavedEl = document.getElementById('lastSaved');
                                if (lastSavedEl) {
                                    lastSavedEl.textContent = formatTimestamp(result.record.lastUpdated);
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Error processing response');
                    }
                }

                // If there are Vi-En cards but no En-Vi cards, switch to Vi-En view
                if (enViCards.length === 0 && viEnCards.length > 0) {
                    const switchBtn = document.getElementById('switchToViEn');
                    if (switchBtn) switchBtn.click();
                }

                // Show/hide card preview based on whether we have cards
                const cardPreview = document.getElementById('cardPreview');
                if (cardPreview) {
                    cardPreview.style.display = (enViCards.length > 0 || viEnCards.length > 0) ? 'block' : 'none';
                }

                return true;
            } catch (error) {
                    return false;
            }
        }

        // Save textbox values to localStorage
        function saveTextboxValues() {
            const textboxes = {
                'englishText': document.getElementById('englishText')?.value || '',
                'vietnameseText': document.getElementById('vietnameseText')?.value || '',
                'englishText2': document.getElementById('englishText2')?.value || '',
                'vietnameseText2': document.getElementById('vietnameseText2')?.value || ''
            };
            
            localStorage.setItem('textboxValues', JSON.stringify(textboxes));
        }
        
        // Load textbox values from localStorage
        function loadTextboxValues() {
            try {
                const savedValues = localStorage.getItem('textboxValues');
                if (savedValues) {
                    const values = JSON.parse(savedValues);
                    Object.keys(values).forEach(id => {
                        const element = document.getElementById(id);
                        if (element && values[id]) {
                            element.value = values[id];
                        }
                    });
                }
            } catch (e) {
                // Silent error
            }
        }
        
        // Initialize the application
        async function initializeApp() {
            try {
                // Add input event listeners to all textboxes first
                const textboxIds = ['englishText', 'vietnameseText', 'englishText2', 'vietnameseText2'];
                textboxIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', saveTextboxValues);
                        element.addEventListener('blur', saveTextboxValues);
                    }
                });
                
                // Load saved textbox values from localStorage
                loadTextboxValues();
                
                // Initialize the page and load data from jsonbin.io
                await initializePage();
                
                // Set data-target for save button if it exists
                const saveCardBtn = document.getElementById('saveCardBtn');
                if (saveCardBtn) {
                    saveCardBtn.setAttribute('data-target', 'enVi');
                }
                
                // Load data from jsonbin.io
                await loadFromJsonBin();
                
                // Save the current state after loading
                saveTextboxValues();
                
                // Add click event listeners to all read buttons
                document.querySelectorAll('.read-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetId = button.getAttribute('data-target');
                        const lang = button.getAttribute('data-lang');
                        const text = document.getElementById(targetId)?.value;
                        if (text) {
                            speakText(text, lang);
                        }
                    });
                });
                
            } catch (error) {
                // Silent error
            }
        }
        
        // Start the application when the DOM is fully loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
        
        // Save button has been removed from UI, so we don't need this event listener anymore

        // Function to create action buttons for a card
        function createActionButtons(cardDiv, isEnToVi = true) {
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'card-actions';
            
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Sửa';
            editBtn.title = 'Sửa thẻ';
            editBtn.onclick = (e) => {
                e.stopPropagation();
                enableEditMode(cardDiv, isEnToVi);
            };
            
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Xóa';
            deleteBtn.title = 'Xóa thẻ';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                if (confirm('Bạn có chắc chắn muốn xóa thẻ này?')) {
                    cardDiv.remove();
                    saveAllData();
                }
            };
            
            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(deleteBtn);
            return actionsDiv;
        }
        
        // Function to enable edit mode for a card
        function enableEditMode(cardDiv, isEnToVi) {
            // Get the card content div which contains term and definition
            const contentDiv = cardDiv.querySelector('.card-content');
            if (!contentDiv) return;
            
            const term = contentDiv.querySelector('.card-term')?.textContent || '';
            const definition = contentDiv.querySelector('.card-definition')?.textContent || '';
            
            // Create input fields
            const editForm = document.createElement('div');
            editForm.className = 'card-content';
            
            const termInput = document.createElement('textarea');
            termInput.value = term;
            termInput.className = 'card-term-edit';
            termInput.style.width = '100%';
            termInput.style.minHeight = '60px';
            
            const definitionInput = document.createElement('textarea');
            definitionInput.value = definition;
            definitionInput.className = 'card-definition-edit';
            definitionInput.style.width = '100%';
            definitionInput.style.minHeight = '60px';
            
            // Create action buttons
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'edit-buttons';
            buttonsDiv.style.gridColumn = '1 / -1';
            
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Lưu';
            saveBtn.className = 'save-btn';
            saveBtn.onclick = (e) => {
                e.stopPropagation();
                const newTerm = termInput.value.trim();
                const newDefinition = definitionInput.value.trim();
                if (newTerm && newDefinition) {
                    // Create new card content
                    cardDiv.innerHTML = '';
                    cardDiv.appendChild(createCardContent(newTerm, newDefinition, isEnToVi));
                    saveAllData();
                }
            };
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Hủy';
            cancelBtn.className = 'cancel-btn';
            cancelBtn.onclick = (e) => {
                e.stopPropagation();
                // Restore original card content
                cardDiv.innerHTML = '';
                cardDiv.appendChild(createCardContent(term, definition, isEnToVi));
            };
            
            buttonsDiv.appendChild(saveBtn);
            buttonsDiv.appendChild(cancelBtn);
            
            // Add elements to edit form
            editForm.appendChild(termInput);
            editForm.appendChild(definitionInput);
            editForm.appendChild(buttonsDiv);
            
            // Replace card content with edit form
            cardDiv.innerHTML = '';
            cardDiv.appendChild(editForm);
            
            // Focus on the first input
            termInput.focus();
        }
        
        // Function to create card content
        function createCardContent(term, definition, isEnToVi) {
            // Create card container
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card-item';
            
            // Create content container
            const contentDiv = document.createElement('div');
            contentDiv.className = 'card-content';
            
            // Create term and definition elements
            const termDiv = document.createElement('div');
            termDiv.className = 'card-term';
            // Preserve newlines and spaces in the text content
            termDiv.style.whiteSpace = 'pre-line';
            termDiv.style.wordBreak = 'break-word';
            termDiv.textContent = term || '';
            
            const definitionDiv = document.createElement('div');
            definitionDiv.className = 'card-definition';
            // Preserve newlines and spaces in the text content
            definitionDiv.style.whiteSpace = 'pre-line';
            definitionDiv.style.wordBreak = 'break-word';
            definitionDiv.textContent = definition || '';
            
            // Add term and definition to content
            if (term) contentDiv.appendChild(termDiv);
            if (definition) contentDiv.appendChild(definitionDiv);
            
            // Add content to card
            cardDiv.appendChild(contentDiv);
            
            // Add action buttons to card (not to content)
            const actions = createActionButtons(cardDiv, isEnToVi);
            cardDiv.insertBefore(actions, contentDiv);
            
            return cardDiv;
        }
        
        // Function to add a card
        function addCard(term, definition, isEnToVi = true) {
            // Allow adding card if at least one field has content
            if (!term && !definition) return false;
            
            const cardList = document.getElementById(isEnToVi ? 'enViCardList' : 'viEnCardList');
            if (!cardList) return false;
            
            // Create card container
            const cardContainer = document.createElement('div');
            cardContainer.className = 'card-item';
            
            // Create and add the card content
            const cardContent = createCardContent(term, definition, isEnToVi);
            cardContainer.appendChild(cardContent);
            
            // Add the card to the list
            cardList.appendChild(cardContainer);
            
            // Show the card preview section if it's hidden
            const cardPreview = document.getElementById('cardPreview');
            if (cardPreview) {
                cardPreview.style.display = 'block';
            }
            
            // Save to localStorage
            saveAllData();
            
            return true;
        }
        
        // Add card button handlers
        document.getElementById('addEnViCardBtn').addEventListener('click', () => {
            const englishText = document.getElementById('englishText').value.trim();
            const vietnameseText = document.getElementById('vietnameseText').value.trim();
            
            if (addCard(englishText, vietnameseText, true)) {
                // Clear the input fields
                document.getElementById('englishText').value = '';
                document.getElementById('vietnameseText').value = '';
            }
        });
        
        document.getElementById('addViEnCardBtn').addEventListener('click', () => {
            const vietnameseText = document.getElementById('vietnameseText2').value.trim();
            const englishText = document.getElementById('englishText2').value.trim();
            
            if (addCard(vietnameseText, englishText, false)) {
                // Clear the input fields
                document.getElementById('vietnameseText2').value = '';
                document.getElementById('englishText2').value = '';
            }
        });

        // Card set switching
        document.getElementById('switchToEnVi').addEventListener('click', function() {
            document.getElementById('enViCardList').style.display = 'block';
            document.getElementById('viEnCardList').style.display = 'none';
            this.style.background = '#4285f4';
            this.style.color = 'white';
            document.getElementById('switchToViEn').style.background = '#f5f5f5';
            document.getElementById('switchToViEn').style.color = '#333';
            // Update save button to target current card set
            document.getElementById('saveCardBtn').setAttribute('data-target', 'enVi');
        });

        document.getElementById('switchToViEn').addEventListener('click', function() {
            document.getElementById('enViCardList').style.display = 'none';
            document.getElementById('viEnCardList').style.display = 'block';
            this.style.background = '#4285f4';
            this.style.color = 'white';
            document.getElementById('switchToEnVi').style.background = '#f5f5f5';
            document.getElementById('switchToEnVi').style.color = '#333';
            // Update save button to target current card set
            document.getElementById('saveCardBtn').setAttribute('data-target', 'viEn');
        });

        // Function to get the currently active card list
        function getActiveCardList() {
            const isEnToVi = document.getElementById('enViCardList').style.display !== 'none';
            return document.getElementById(isEnToVi ? 'enViCardList' : 'viEnCardList');
        }

        // Delete cards button click handler
        document.getElementById('deleteCardsBtn').addEventListener('click', () => {
            if (confirm('Bạn có chắc chắn muốn xóa tất cả thẻ trong bộ hiện tại không?')) {
                const cardList = getActiveCardList();
                cardList.innerHTML = '';
                saveAllData();
                
                // Show success message
                const deleteBtn = document.getElementById('deleteCardsBtn');
                const originalText = deleteBtn.textContent;
                deleteBtn.textContent = 'Đã xóa!';
                
                setTimeout(() => {
                    deleteBtn.textContent = originalText;
                }, 2000);
            }
        });

        // Save card button click handler
        document.getElementById('saveCardBtn').addEventListener('click', () => {
            const cardList = getActiveCardList();
            const isEnToVi = cardList.id === 'enViCardList';
            const cards = [];
            
            // Get all cards from the active list
            cardList.querySelectorAll('.card-item').forEach(cardEl => {
                const term = cardEl.querySelector('.card-term')?.textContent?.trim();
                const definition = cardEl.querySelector('.card-definition')?.textContent?.trim();
                
                if (term && definition) {
                    cards.push({
                        term: term,
                        definition: definition,
                        timestamp: new Date().toISOString()
                    });
                }
            });
            
            // Save to file
            const filename = isEnToVi ? 'english_vietnamese_cards.json' : 'vietnamese_english_cards.json';
            saveCardsToFile(cards, filename);
            
            // Show success message
            const saveBtn = document.getElementById('saveCardBtn');
            saveBtn.style.background = '#ffffff';
            saveBtn.style.border = '1px solid #dadce0';
            saveBtn.style.padding = '5px 10px';
            saveBtn.style.borderRadius = '4px';
            saveBtn.style.cursor = 'pointer';
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Đã lưu!';
            saveBtn.style.fontWeight = 'bold';
            
            // Reset button after 2 seconds
            setTimeout(() => {
                saveBtn.textContent = originalText;
                saveBtn.style.fontWeight = 'normal';
            }, 2000);
        });

        // Translate button handlers
        document.getElementById('translateEnToViBtn').addEventListener('click', async () => {
            const englishText = document.getElementById('englishText').value.trim();
            const vietnameseText = document.getElementById('vietnameseText');
            
            if (!englishText) {
                alert('Vui lòng nhập văn bản cần dịch');
                return;
            }

            try {
                // Using Google Translate website for translation
                const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=vi&dt=t&q=${encodeURIComponent(englishText)}`);
                
                if (!response.ok) {
                    throw new Error('Translation failed');
                }
                
                const data = await response.json();
                
                // Extract the translated text from the response
                if (data && data[0] && data[0][0] && data[0][0][0]) {
                    vietnameseText.value = data[0].map(item => item[0]).join('');
                } else {
                    throw new Error('Could not parse translation');
                }
            } catch (error) {
                console.error('Translation error:', error);
                vietnameseText.value = 'Lỗi: Không thể dịch văn bản. Vui lòng kiểm tra kết nối mạng và thử lại.';
            }
        });
        
        // Vietnamese to English translation
        document.getElementById('translateViToEnBtn').addEventListener('click', async () => {
            const vietnameseText = document.getElementById('vietnameseText2').value.trim();
            const englishText = document.getElementById('englishText2');
            
            if (!vietnameseText) {
                alert('Vui lòng nhập văn bản cần dịch');
                return;
            }
            
            try {
                // Using Google Translate website for translation
                const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=vi&tl=en&dt=t&q=${encodeURIComponent(vietnameseText)}`);
                
                if (!response.ok) {
                    throw new Error('Translation failed');
                }
                
                const data = await response.json();
                
                // Extract the translated text from the response
                if (data && data[0] && data[0][0] && data[0][0][0]) {
                    englishText.value = data[0].map(item => item[0]).join('');
                } else {
                    throw new Error('Could not parse translation');
                }
            } catch (error) {
                console.error('Translation error:', error);
                englishText.value = 'Error: Could not translate text. Please check your internet connection and try again.';
            }
        });
    </script>
</body>
</html>
