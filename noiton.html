<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Notion DB Search - Demo</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:20px;max-width:960px;margin:auto}
    input, button, textarea {padding:8px;margin:6px 0;border:1px solid #ccc;border-radius:6px}
    .row{display:flex;gap:8px;align-items:center}
    .token{width:100%}
    .card{border:1px solid #eee;padding:12px;border-radius:8px;margin:8px 0}
    .muted{color:#666;font-size:0.9em}
    .error{color:#a00}
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px;border-bottom:1px solid #eee;text-align:left}
  </style>
</head>
<body>
  <h1>Notion — Search Databases (Demo)</h1>

  <p class="muted">
    Nhập <strong>Internal Integration Token</strong> (secret_xxx...) và từ khóa để tìm database.
  </p>

  <div class="card">
    <label><strong>1) Notion Integration Secret Token</strong></label><br/>
    <input id="token" class="token" placeholder="secret_xxx..." />
    <div class="muted">Cảnh báo: dán token vào trang này trên máy riêng ok; <strong>không</strong> dán token vào trang công khai hoặc máy người khác.</div>
  </div>

  <div class="card">
    <label><strong>2) Từ khóa tìm kiếm (query)</strong></label><br/>
    <input id="query" placeholder="ví dụ: flashcard, vocabulary, users..." style="width:60%" />
    <button id="searchBtn">Search databases</button>
    <button id="clearBtn">Clear</button>
    <div class="muted" id="note">Nếu để trống, API có thể trả về tất cả database mà token có quyền truy cập.</div>
  </div>

  <div id="status" class="muted"></div>
  <div id="error" class="error"></div>

  <div id="results"></div>

  <script>
    const API_ENDPOINT = "https://api.notion.com/v1/search";
    const NOTION_VERSION = "2022-06-28"; // header yêu cầu

    const tokenInput = document.getElementById("token");
    const queryInput = document.getElementById("query");
    const resultsDiv = document.getElementById("results");
    const statusDiv = document.getElementById("status");
    const errorDiv = document.getElementById("error");
    const searchBtn = document.getElementById("searchBtn");
    const clearBtn = document.getElementById("clearBtn");

    let lastCursor = null;

    function setStatus(s){ statusDiv.textContent = s || ""; }
    function setError(e){ errorDiv.textContent = e || ""; }

    async function notionSearch(token, query, start_cursor=null){
      const body = {
        filter: { property: "object", value: "database" },
        page_size: 100
      };
      if(query) body.query = query;
      if(start_cursor) body.start_cursor = start_cursor;

      const res = await fetch(API_ENDPOINT, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json",
          "Notion-Version": NOTION_VERSION
        },
        body: JSON.stringify(body)
      });

      // Nếu Notion trả lỗi CORS, trình duyệt sẽ block trước khi đến đây.
      if(!res.ok){
        const text = await res.text().catch(()=>"");
        throw new Error("HTTP " + res.status + " - " + text);
      }
      return res.json();
    }

    function renderResults(data){
      resultsDiv.innerHTML = "";
      if(!data || !data.results || data.results.length===0){
        resultsDiv.innerHTML = "<div class='muted'>Không có database phù hợp.</div>";
        return;
      }

      let html = "<table><thead><tr><th>Tên</th><th>ID</th><th>Parent (page_id)</th><th>Link</th></tr></thead><tbody>";
      data.results.forEach(db => {
        const title = (db.title && db.title[0] && db.title[0].plain_text) ? db.title[0].plain_text : "(untitled)";
        const id = db.id;
        const parent = db.parent?.page_id || db.parent?.workspace || "";
        const link = makeNotionLink(id);
        html += `<tr><td>${escapeHtml(title)}</td><td style="font-family:monospace">${id}</td><td>${escapeHtml(parent)}</td><td><a href="${link}" target="_blank">Open</a></td></tr>`;
      });
      html += "</tbody></table>";

      // paging controls
      if(data.has_more){
        html += `<div style="margin-top:12px">
                  <button id="moreBtn">Load more</button>
                 </div>`;
      }

      resultsDiv.innerHTML = html;

      const moreBtn = document.getElementById("moreBtn");
      if(moreBtn){
        moreBtn.addEventListener("click", async () => {
          setStatus("Đang tải thêm...");
          setError("");
          try {
            const token = tokenInput.value.trim();
            const next = await notionSearch(token, queryInput.value.trim(), data.next_cursor);
            // append results
            const combined = {
              results: (data.results || []).concat(next.results || []),
              has_more: next.has_more,
              next_cursor: next.next_cursor
            };
            renderResults(combined);
            setStatus("");
          } catch (err) {
            setError(String(err.message || err));
            setStatus("");
          }
        });
      }

    }

    function escapeHtml(s){
      if(!s) return "";
      return s.replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));
    }

    function makeNotionLink(id){
      // Notion sẽ redirect nếu dùng id không có dấu '-', dùng dạng không-dash
      const noDash = id.replace(/-/g,"");
      return "https://www.notion.so/" + noDash;
    }

    searchBtn.addEventListener("click", async () => {
      setStatus("Đang tìm...");
      setError("");
      resultsDiv.innerHTML = "";
      const token = tokenInput.value.trim();
      if(!token){
        setError("Bạn cần nhập Notion token (secret_xxx).");
        setStatus("");
        return;
      }
      try{
        const data = await notionSearch(token, queryInput.value.trim());
        renderResults(data);
        setStatus("");
      }catch(err){
        // CORS check: trình duyệt sẽ block, fetch sẽ reject with TypeError: Failed to fetch
        if(err instanceof TypeError){
          setError("Lỗi: Có thể trình duyệt chặn (CORS). Notion API không cho phép gọi trực tiếp từ browser. Hãy dùng proxy/backend (xem hướng dẫn bên dưới).");
        } else {
          setError(String(err.message || err));
        }
        setStatus("");
      }
    });

    clearBtn.addEventListener("click", () => {
      tokenInput.value = "";
      queryInput.value = "";
      resultsDiv.innerHTML = "";
      setError("");
      setStatus("");
    });

    // small note about direct browser calls:
    (function showCORSWarning(){
      const note = document.getElementById("note");
      const warn = document.createElement("div");
      warn.className = "muted";
      warn.style.marginTop = "6px";
      warn.innerHTML = "<strong>Chú ý:</strong> Notion API thường <em>không</em> cho phép gọi trực tiếp từ browser (CORS). Nếu bạn thấy lỗi CORS, hãy dùng backend proxy. Mình có ví dụ proxy trong phần hướng dẫn.";
      note.parentNode.appendChild(warn);
    })();
  </script>
</body>
</html>
